<div class="table-comparison">
    {% set schema_count = table.schema | length %}
    {% set data_count = table.data | length %}
    {% set total_changes = schema_count + data_count %}
    
    <h3 class="expandable" onclick="toggleCollapsible(this)">
        {{ table.name }} ({{ total_changes }} changes)
    </h3>
    <div class="collapsible-content">
        {% if (table.schema | length) > 0 %}
            <h4>Schema Changes ({{ table.schema | length }} total)</h4>
            {% for change in table.schema %}
                <div class="change-item {{ change | get_change_type }}">
                    <div class="change-header">
                        <span class="change-type {{ change | get_change_type }}">{{ change | get_change_type }}</span>
                        Column: {{ change.name }}
                    </div>
                    
                    {% if change | get_change_type == 'added' %}
                        <div class="change-content">
                            <div class="change-side single-side added">
                                <div class="side-header">New Column Definition</div>
                                <div class="side-content">{{ change.new | tojson(indent=2) }}</div>
                                <div class="added-indicator">+ Added</div>
                            </div>
                        </div>
                    {% elif change | get_change_type == 'removed' %}
                        <div class="change-content">
                            <div class="change-side single-side removed">
                                <div class="side-header">Removed Column Definition</div>
                                <div class="side-content">{{ change.old | tojson(indent=2) }}</div>
                                <div class="removed-indicator">- Removed</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="change-content">
                            <div class="change-side">
                                <div class="side-header">Source (Old)</div>
                                <div class="side-content">{{ change.old | tojson(indent=2) }}</div>
                            </div>
                            <div class="change-side">
                                <div class="side-header">Target (New)</div>
                                <div class="side-content">{{ change.new | tojson(indent=2) }}</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {% if (table.data | length) > 0 %}
            <h4>Data Changes ({{ table.data | length }} total)</h4>
            {% for change in table.data %}
                <div class="change-item {{ change | get_change_type }}">
                    <div class="change-header">
                        <span class="change-type {{ change | get_change_type }}">{{ change | get_change_type }}</span>
                        Row: 
                        {% for key, value in change.key.items() %}
                            {{ key }}={{ value | format_value }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                    
                    {% if change | get_change_type == 'added' %}
                        <div class="change-content">
                            <div class="change-side single-side added">
                                <div class="side-header">New Row Data</div>
                                <div class="side-content">{{ change.new | tojson(indent=2) }}</div>
                                <div class="added-indicator">+ Added</div>
                            </div>
                        </div>
                    {% elif change | get_change_type == 'removed' %}
                        <div class="change-content">
                            <div class="change-side single-side removed">
                                <div class="side-header">Removed Row Data</div>
                                <div class="side-content">{{ change.old | tojson(indent=2) }}</div>
                                <div class="removed-indicator">- Removed</div>
                            </div>
                        </div>
                    {% else %}
                        <div class="change-content">
                            <div class="change-side">
                                <div class="side-header">Source (Old)</div>
                                <div class="side-content">{{ change.old | tojson(indent=2) }}</div>
                            </div>
                            <div class="change-side">
                                <div class="side-header">Target (New)</div>
                                <div class="side-content">{{ change.new | tojson(indent=2) }}</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>