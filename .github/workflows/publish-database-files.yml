name: Publish Database Files

on:
  workflow_dispatch:
    inputs:
      version_id:
        description: "Database version to publish (e.g., 4.1-final)"
        required: true
        type: string
      prerelease:
        description: "Mark as prerelease"
        required: false
        type: boolean
        default: false

env:
  VERSION_ID: ${{ inputs.version_id }}

jobs:
  download-original:
    uses: ./.github/workflows/download-database.yml
    with:
      version_id: ${{ inputs.version_id }}
      database_type: "original"

  build-converted:
    needs: download-original
    uses: ./.github/workflows/migrate-database.yml
    with:
      source_artifact_name: ${{ needs.download-original.outputs.artifact_name }}

  analyze-converted:
    needs: build-converted
    uses: ./.github/workflows/analyze-database.yml
    with:
      sqlite_artifact_name: ${{ needs.build-converted.outputs.artifact_name }}
      confidence_threshold: "0.8"

  create-release:
    needs: [download-original, build-converted, analyze-converted]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5

      - name: Set release tag
        run: |
          RELEASE_TAG="db-${{ env.VERSION_ID }}"
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV

      - name: Download original files for archive
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.download-original.outputs.artifact_name }}
          path: archive-files/

      - name: Download SQLite database for converted
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.build-converted.outputs.artifact_name }}
          path: converted-files/

      - name: Download analysis reports
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.analyze-converted.outputs.artifact_name }}
          path: analysis-files/

      - name: Create archive zip
        run: |
          cd archive-files
          zip -r "../dpm-${{ env.VERSION_ID }}-archive.zip" .

      - name: Create SQLite zip
        run: |
          cd converted-files
          zip "../dpm-${{ env.VERSION_ID }}-sqlite.zip" *.sqlite

      - name: Create analysis zip
        run: |
          cd analysis-files
          zip -r "../dpm-${{ env.VERSION_ID }}-analysis.zip" .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "DPM Database Files - ${{ env.VERSION_ID }}"
          body: |
            Database files for version ${{ env.VERSION_ID }}

            **Available Downloads:**
            - `dpm-${{ env.VERSION_ID }}-archive.zip` - Original Access database files
            - `dpm-${{ env.VERSION_ID }}-sqlite.zip` - Converted SQLite database
            - `dpm-${{ env.VERSION_ID }}-analysis.zip` - Type refinement analysis reports (JSON + Markdown)
          prerelease: ${{ inputs.prerelease }}
          files: dpm-${{ env.VERSION_ID }}-*.zip
