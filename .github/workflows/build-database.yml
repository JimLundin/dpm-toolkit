name: Build Database

on:
  workflow_call:
    inputs:
      version_id:
        description: "The version ID to build."
        required: true
        type: string
    outputs:
      artifact_name:
        description: "The name of the uploaded artifact containing the built database and schema"
        value: ${{ inputs.version_id }}

jobs:
  migrate:
    uses: ./.github/workflows/migrate-database.yml
    with:
      version_id: ${{ inputs.version_id }}

  generate-schema:
    needs: migrate
    uses: ./.github/workflows/generate-schema.yml
    with:
      version_id: ${{ inputs.version_id }}
      sqlite_artifact_name: ${{ needs.migrate.outputs.artifact_name }}

  combine-artifacts:
    needs: [migrate, generate-schema]
    runs-on: ubuntu-latest
    steps:
      - name: Download SQLite database artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.migrate.outputs.artifact_name }}

      - name: Download schema artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.generate-schema.outputs.artifact_name }}

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.version_id }}
          path: |
            dpm.sqlite
            dpm.py
